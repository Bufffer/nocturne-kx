cmake_minimum_required(VERSION 3.20)
project(nocturne-kx VERSION 3.0.0 LANGUAGES CXX)

set(CMAKE_CXX_STANDARD 23)
set(CMAKE_CXX_STANDARD_REQUIRED ON)
set(CMAKE_EXPORT_COMPILE_COMMANDS ON)

# ========================================
# MILITARY-GRADE BUILD OPTIONS
# ========================================
option(ENABLE_FIPS "Enable FIPS 140-3 mode" ON)
option(BUILD_SHARED_LIBS "Build shared libraries instead of static" OFF)
option(ENABLE_HARDENING "Enable security hardening flags" ON)
option(ENABLE_TESTING "Build tests" OFF)
option(ENABLE_FUZZING "Build fuzzer" OFF)
option(ENABLE_SANITIZERS "Enable sanitizers (ASan, UBSan)" OFF)
option(ENABLE_LTO "Enable Link-Time Optimization" ON)

# ========================================
# COMPILER FLAGS
# ========================================
set(CMAKE_CXX_FLAGS "${CMAKE_CXX_FLAGS} -Wall -Wextra -Wpedantic -Werror")

# Security hardening flags (MIL-STD compliant)
if(ENABLE_HARDENING)
    set(SECURITY_FLAGS
        -D_FORTIFY_SOURCE=2           # Buffer overflow protection
        -fstack-protector-strong      # Stack canaries
        -fPIE                         # Position Independent Executable
        -Wl,-z,relro                  # RELRO (relocation read-only)
        -Wl,-z,now                    # Full RELRO (no lazy binding)
        -Wl,-z,noexecstack            # NX stack
        -fno-delete-null-pointer-checks
        -fwrapv                       # Defined integer overflow behavior
    )

    # Intel CET (Control Flow Integrity) for x86-64
    if(CMAKE_SYSTEM_PROCESSOR MATCHES "x86_64|AMD64")
        list(APPEND SECURITY_FLAGS -fcf-protection=full)
    endif()

    add_compile_options(${SECURITY_FLAGS})
    add_link_options(-pie ${SECURITY_FLAGS})
endif()

# Release optimization
set(CMAKE_CXX_FLAGS_RELEASE "${CMAKE_CXX_FLAGS_RELEASE} -O3 -DNDEBUG")

# Link-Time Optimization
if(ENABLE_LTO AND NOT ENABLE_FUZZING)
    set(CMAKE_INTERPROCEDURAL_OPTIMIZATION TRUE)
endif()

# Platform-specific flags for side-channel protection
if(CMAKE_CXX_COMPILER_ID MATCHES "GNU|Clang")
    if(CMAKE_SYSTEM_PROCESSOR MATCHES "x86_64|i386")
        set(CMAKE_CXX_FLAGS "${CMAKE_CXX_FLAGS} -msse2")
    endif()
endif()

# Sanitizers (for development/testing)
if(ENABLE_SANITIZERS)
    set(SANITIZER_FLAGS -fsanitize=address,undefined -fno-omit-frame-pointer)
    add_compile_options(${SANITIZER_FLAGS})
    add_link_options(${SANITIZER_FLAGS})
endif()

# FIPS mode
if(ENABLE_FIPS)
    add_compile_definitions(NOCTURNE_FIPS_MODE)
endif()

# ========================================
# DEPENDENCIES
# ========================================
find_package(PkgConfig REQUIRED)
pkg_check_modules(SODIUM REQUIRED libsodium)

# OpenSSL (for TLS transport)
find_package(OpenSSL QUIET)
if(OpenSSL_FOUND)
    add_compile_definitions(NOCTURNE_HAS_OPENSSL)
endif()

# ========================================
# LIBRARY STRUCTURE
# ========================================

# Core library - cryptographic primitives and utilities
add_library(nocturne-core
    src/core/side_channel.cpp
    src/core/side_channel.hpp
    # src/core/secure_memory.cpp  # To be extracted
    # src/core/crypto_primitives.cpp  # To be extracted
)
target_include_directories(nocturne-core PUBLIC
    ${CMAKE_CURRENT_SOURCE_DIR}/src
    ${SODIUM_INCLUDE_DIRS}
)
target_link_libraries(nocturne-core PUBLIC ${SODIUM_LIBRARIES})
target_compile_options(nocturne-core PRIVATE ${SODIUM_CFLAGS_OTHER})

# Protocol library - handshake, double ratchet, transport
add_library(nocturne-protocol
    src/double_ratchet.hpp
    src/handshake.hpp
    src/transport.hpp
)
target_include_directories(nocturne-protocol PUBLIC
    ${CMAKE_CURRENT_SOURCE_DIR}/src
    ${SODIUM_INCLUDE_DIRS}
)
target_link_libraries(nocturne-protocol PUBLIC
    nocturne-core
    ${SODIUM_LIBRARIES}
)
set_target_properties(nocturne-protocol PROPERTIES LINKER_LANGUAGE CXX)

# Security library - replay protection, rate limiting, audit logging
# Note: Currently header-only, will be compiled when needed
# Uncomment when source files are extracted:
# add_library(nocturne-security
#     src/security/replay_protection.cpp
#     src/security/rate_limiter.cpp
#     src/security/audit_logger.cpp
#     src/security/key_rotation.cpp
# )
# target_include_directories(nocturne-security PUBLIC
#     ${CMAKE_CURRENT_SOURCE_DIR}/src
# )
# target_link_libraries(nocturne-security PUBLIC
#     nocturne-core
#     nocturne-protocol
# )

# HSM library - PKCS#11, TPM, FileHSM
add_library(nocturne-hsm
    src/pkcs11_wrapper.cpp
    src/pkcs11_wrapper.hpp
    # src/hsm/hsm_interface.hpp  # To be extracted
    # src/hsm/file_hsm.cpp  # To be extracted
    # src/hsm/pkcs11_hsm.cpp  # NEW - production PKCS#11
    # src/hsm/tpm_hsm.cpp  # NEW - TPM 2.0 integration
)
target_include_directories(nocturne-hsm PUBLIC
    ${CMAKE_CURRENT_SOURCE_DIR}/src
)
target_link_libraries(nocturne-hsm PUBLIC
    nocturne-core
    ${CMAKE_DL_LIBS}  # For dlopen (PKCS#11 loading)
)

# Network library - TCP/TLS, QUIC transports (NEW)
if(OpenSSL_FOUND)
    add_library(nocturne-network
        # src/network/tcp_transport.cpp  # NEW
        # src/network/tls_transport.cpp  # NEW
        # src/network/adapter_interface.hpp  # NEW
    )
    target_include_directories(nocturne-network PUBLIC
        ${CMAKE_CURRENT_SOURCE_DIR}/src
    )
    target_link_libraries(nocturne-network PUBLIC
        nocturne-core
        nocturne-protocol
        OpenSSL::SSL
        OpenSSL::Crypto
    )
    # Temporarily disable until source files created
    set_target_properties(nocturne-network PROPERTIES
        LINKER_LANGUAGE CXX
        EXCLUDE_FROM_ALL TRUE
    )
endif()

# ========================================
# MAIN EXECUTABLE
# ========================================
if(NOT ENABLE_FUZZING)
    add_executable(nocturne-kx nocturne-kx.cpp)
    target_include_directories(nocturne-kx PRIVATE
        ${CMAKE_CURRENT_SOURCE_DIR}/src
        ${SODIUM_INCLUDE_DIRS}
    )
    target_link_libraries(nocturne-kx PRIVATE
        nocturne-core
        nocturne-protocol
        nocturne-hsm
        # nocturne-security  # Enable after extraction
        ${SODIUM_LIBRARIES}
    )

    if(OpenSSL_FOUND)
        # target_link_libraries(nocturne-kx PRIVATE nocturne-network)
    endif()

    target_compile_options(nocturne-kx PRIVATE ${SODIUM_CFLAGS_OTHER})
endif()

# ========================================
# TESTING
# ========================================
if(ENABLE_TESTING)
    enable_testing()

    find_package(Catch2 3 QUIET)
    if(Catch2_FOUND)
        # Unit tests
        add_executable(nocturne-tests tests/test_main.cpp)
        target_link_libraries(nocturne-tests PRIVATE
            Catch2::Catch2WithMain
            nocturne-core
            nocturne-protocol
            nocturne-hsm
            ${SODIUM_LIBRARIES}
        )
        target_include_directories(nocturne-tests PRIVATE
            ${CMAKE_CURRENT_SOURCE_DIR}/src
            ${SODIUM_INCLUDE_DIRS}
        )

        # Register tests
        include(CTest)
        include(Catch)
        catch_discover_tests(nocturne-tests)

        # PKCS#11 integration tests
        add_executable(pkcs11-integration-tests tests/pkcs11_integration.cpp)
        target_link_libraries(pkcs11-integration-tests PRIVATE
            Catch2::Catch2WithMain
            nocturne-hsm
            ${SODIUM_LIBRARIES}
        )
        target_include_directories(pkcs11-integration-tests PRIVATE
            ${CMAKE_CURRENT_SOURCE_DIR}/src
        )

        catch_discover_tests(pkcs11-integration-tests)
    else()
        message(WARNING "Catch2 not found, tests will be disabled")
    endif()
endif()

# ========================================
# FUZZING
# ========================================
if(ENABLE_FUZZING)
    set(CMAKE_CXX_COMPILER_WORKS TRUE)

    add_executable(nocturne-fuzzer tests/fuzzer_main.cpp)
    target_link_libraries(nocturne-fuzzer
        nocturne-core
        nocturne-protocol
        ${SODIUM_LIBRARIES}
    )
    target_include_directories(nocturne-fuzzer PRIVATE
        ${CMAKE_CURRENT_SOURCE_DIR}/src
        ${SODIUM_INCLUDE_DIRS}
    )
endif()

# ========================================
# STATIC ANALYSIS
# ========================================
find_program(CLANG_TIDY clang-tidy)
if(CLANG_TIDY AND NOT ENABLE_FUZZING)
    set(CMAKE_CXX_CLANG_TIDY
        ${CLANG_TIDY}
        -checks=*,-fuchsia-*,-google-*,-llvm-*,-modernize-use-trailing-return-type
        -warnings-as-errors=*
    )
endif()

find_program(CPPCHECK cppcheck)
if(CPPCHECK)
    add_custom_target(cppcheck
        COMMAND ${CPPCHECK}
        --enable=all
        --std=c++23
        --suppress=missingIncludeSystem
        --error-exitcode=1
        ${CMAKE_CURRENT_SOURCE_DIR}/src
        ${CMAKE_CURRENT_SOURCE_DIR}/nocturne-kx.cpp
    )
endif()

# ========================================
# INSTALLATION
# ========================================
if(NOT ENABLE_FUZZING)
    install(TARGETS nocturne-kx DESTINATION bin)

    # Install libraries
    install(TARGETS nocturne-core nocturne-protocol nocturne-hsm
        LIBRARY DESTINATION lib
        ARCHIVE DESTINATION lib
        RUNTIME DESTINATION bin
    )

    # Install headers
    install(DIRECTORY src/
        DESTINATION include/nocturne
        FILES_MATCHING PATTERN "*.hpp"
    )
endif()

if(ENABLE_TESTING AND Catch2_FOUND)
    install(TARGETS nocturne-tests pkcs11-integration-tests DESTINATION bin)
endif()

# ========================================
# DOCUMENTATION
# ========================================
add_custom_target(docs
    COMMENT "Documentation target (README, SECURITY.md, OPERATIONS.md, etc.)"
)

# ========================================
# SUMMARY
# ========================================
message(STATUS "===========================================")
message(STATUS "Nocturne-KX Configuration Summary")
message(STATUS "===========================================")
message(STATUS "Version: ${PROJECT_VERSION}")
message(STATUS "Build type: ${CMAKE_BUILD_TYPE}")
message(STATUS "C++ Standard: C++${CMAKE_CXX_STANDARD}")
message(STATUS "Compiler: ${CMAKE_CXX_COMPILER_ID} ${CMAKE_CXX_COMPILER_VERSION}")
message(STATUS "")
message(STATUS "Options:")
message(STATUS "  ENABLE_FIPS: ${ENABLE_FIPS}")
message(STATUS "  ENABLE_HARDENING: ${ENABLE_HARDENING}")
message(STATUS "  ENABLE_LTO: ${ENABLE_LTO}")
message(STATUS "  ENABLE_TESTING: ${ENABLE_TESTING}")
message(STATUS "  ENABLE_FUZZING: ${ENABLE_FUZZING}")
message(STATUS "  ENABLE_SANITIZERS: ${ENABLE_SANITIZERS}")
message(STATUS "  BUILD_SHARED_LIBS: ${BUILD_SHARED_LIBS}")
message(STATUS "")
message(STATUS "Dependencies:")
message(STATUS "  libsodium: ${SODIUM_VERSION}")
message(STATUS "  OpenSSL: ${OPENSSL_VERSION} (${OpenSSL_FOUND})")
if(Catch2_FOUND)
    message(STATUS "  Catch2: Found")
endif()
message(STATUS "===========================================")
