name: Security Scan

on:
  push:
    branches: [ "main", "develop" ]
  pull_request:
    branches: [ "main" ]
  schedule:
    # Run daily at 2 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch:  # Manual trigger

env:
  IMAGE_NAME: nocturne-kx
  IMAGE_TAG: ${{ github.sha }}

jobs:
  # ===========================================================================
  # Static Analysis (SAST)
  # ===========================================================================
  static-analysis:
    name: Static Code Analysis
    runs-on: ubuntu-latest
    permissions:
      security-events: write
      actions: read
      contents: read

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          libsodium-dev \
          pkg-config \
          cmake \
          cppcheck \
          clang-tidy \
          clang-format

    # ------------------------------------------------------------------------
    # cppcheck (C/C++ static analyzer)
    # ------------------------------------------------------------------------
    - name: Run cppcheck
      run: |
        cppcheck \
          --enable=all \
          --std=c++23 \
          --suppress=missingIncludeSystem \
          --suppress=unusedFunction \
          --error-exitcode=0 \
          --xml \
          --output-file=cppcheck-report.xml \
          src/ nocturne-kx.cpp

    - name: Upload cppcheck results
      uses: actions/upload-artifact@v4
      with:
        name: cppcheck-report
        path: cppcheck-report.xml

    # ------------------------------------------------------------------------
    # clang-tidy (Linter and static analyzer)
    # ------------------------------------------------------------------------
    - name: Configure CMake for clang-tidy
      run: |
        cmake -B build \
          -DCMAKE_BUILD_TYPE=Debug \
          -DCMAKE_EXPORT_COMPILE_COMMANDS=ON \
          -DCMAKE_CXX_COMPILER=clang++

    - name: Run clang-tidy
      run: |
        clang-tidy \
          -p build \
          --checks='*,-fuchsia-*,-google-*,-llvm-*,-modernize-use-trailing-return-type' \
          src/**/*.cpp \
          nocturne-kx.cpp \
          || true  # Don't fail build on warnings (for now)

    # ------------------------------------------------------------------------
    # CodeQL Analysis (GitHub Security)
    # ------------------------------------------------------------------------
    - name: Initialize CodeQL
      uses: github/codeql-action/init@v3
      with:
        languages: cpp
        queries: security-extended

    - name: Build for CodeQL
      run: |
        cmake -B build -DCMAKE_BUILD_TYPE=Release
        cmake --build build

    - name: Perform CodeQL Analysis
      uses: github/codeql-action/analyze@v3
      with:
        category: "/language:cpp"

  # ===========================================================================
  # Dependency Scanning
  # ===========================================================================
  dependency-scan:
    name: Dependency Vulnerability Scan
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    # ------------------------------------------------------------------------
    # SBOM Generation (Software Bill of Materials)
    # ------------------------------------------------------------------------
    - name: Install syft
      run: |
        curl -sSfL https://raw.githubusercontent.com/anchore/syft/main/install.sh | sh -s -- -b /usr/local/bin

    - name: Generate SBOM
      run: |
        syft dir:. -o spdx-json > sbom.spdx.json
        syft dir:. -o cyclonedx-json > sbom.cyclonedx.json

    - name: Upload SBOM artifacts
      uses: actions/upload-artifact@v4
      with:
        name: sbom
        path: |
          sbom.spdx.json
          sbom.cyclonedx.json

    # ------------------------------------------------------------------------
    # Vulnerability Scanning with Grype
    # ------------------------------------------------------------------------
    - name: Install grype
      run: |
        curl -sSfL https://raw.githubusercontent.com/anchore/grype/main/install.sh | sh -s -- -b /usr/local/bin

    - name: Scan for vulnerabilities
      run: |
        grype dir:. --fail-on high --output json > grype-report.json || true

    - name: Upload vulnerability report
      uses: actions/upload-artifact@v4
      with:
        name: vulnerability-report
        path: grype-report.json

  # ===========================================================================
  # Container Security Scanning
  # ===========================================================================
  container-scan:
    name: Container Image Security Scan
    runs-on: ubuntu-latest
    needs: [static-analysis]  # Wait for build

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Build Docker image
      uses: docker/build-push-action@v5
      with:
        context: .
        file: ./Dockerfile
        push: false
        load: true
        tags: ${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }}
        cache-from: type=gha
        cache-to: type=gha,mode=max

    # ------------------------------------------------------------------------
    # Trivy Container Scan
    # ------------------------------------------------------------------------
    - name: Run Trivy vulnerability scanner
      uses: aquasecurity/trivy-action@master
      with:
        image-ref: ${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }}
        format: 'sarif'
        output: 'trivy-results.sarif'
        severity: 'CRITICAL,HIGH'

    - name: Upload Trivy results to GitHub Security
      uses: github/codeql-action/upload-sarif@v3
      if: always()
      with:
        sarif_file: 'trivy-results.sarif'

    - name: Run Trivy (JSON output)
      uses: aquasecurity/trivy-action@master
      with:
        image-ref: ${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }}
        format: 'json'
        output: 'trivy-report.json'

    - name: Upload Trivy JSON report
      uses: actions/upload-artifact@v4
      with:
        name: trivy-report
        path: trivy-report.json

    # ------------------------------------------------------------------------
    # Dockle Container Linter
    # ------------------------------------------------------------------------
    - name: Run Dockle
      uses: erzz/dockle-action@v1
      with:
        image: ${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }}
        exit-code: '0'  # Don't fail on warnings
        exit-level: fatal

  # ===========================================================================
  # Secret Scanning
  # ===========================================================================
  secret-scan:
    name: Secret Detection
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Full history for gitleaks

    # ------------------------------------------------------------------------
    # Gitleaks (Secret detection)
    # ------------------------------------------------------------------------
    - name: Run Gitleaks
      uses: gitleaks/gitleaks-action@v2
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    # ------------------------------------------------------------------------
    # TruffleHog (Secret scanning)
    # ------------------------------------------------------------------------
    - name: TruffleHog OSS
      # Skip on push to main where BASE==HEAD
      if: github.event_name == 'pull_request' || github.event.before != github.event.after
      uses: trufflesecurity/trufflehog@main
      with:
        path: ./
        base: ${{ github.event_name == 'pull_request' && github.event.pull_request.base.sha || github.event.before }}
        head: HEAD
        extra_args: --debug --only-verified

  # ===========================================================================
  # License Compliance
  # ===========================================================================
  license-check:
    name: License Compliance Check
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install FOSSA CLI
      run: |
        curl -H 'Cache-Control: no-cache' https://raw.githubusercontent.com/fossas/fossa-cli/master/install-latest.sh | bash

    - name: Run FOSSA analysis
      run: |
        fossa analyze || true  # May require FOSSA_API_KEY
      env:
        FOSSA_API_KEY: ${{ secrets.FOSSA_API_KEY }}

  # ===========================================================================
  # Supply Chain Security
  # ===========================================================================
  supply-chain:
    name: Supply Chain Security
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: read

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    # ------------------------------------------------------------------------
    # Scorecard (OpenSSF)
    # ------------------------------------------------------------------------
    - name: Run Scorecard
      uses: ossf/scorecard-action@v2.4.0
      with:
        results_file: scorecard-results.sarif
        results_format: sarif
        publish_results: true

    - name: Upload Scorecard results
      uses: github/codeql-action/upload-sarif@v3
      with:
        sarif_file: scorecard-results.sarif

  # ===========================================================================
  # Security Summary Report
  # ===========================================================================
  security-summary:
    name: Security Summary
    runs-on: ubuntu-latest
    needs: [static-analysis, dependency-scan, container-scan, secret-scan]
    if: always()

    steps:
    - name: Download all artifacts
      uses: actions/download-artifact@v4

    - name: Generate security summary
      run: |
        echo "# Security Scan Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## Scans Completed" >> $GITHUB_STEP_SUMMARY
        echo "- ✅ Static Analysis (cppcheck, clang-tidy, CodeQL)" >> $GITHUB_STEP_SUMMARY
        echo "- ✅ Dependency Scan (SBOM, Grype)" >> $GITHUB_STEP_SUMMARY
        echo "- ✅ Container Scan (Trivy, Dockle)" >> $GITHUB_STEP_SUMMARY
        echo "- ✅ Secret Detection (Gitleaks, TruffleHog)" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## Artifacts" >> $GITHUB_STEP_SUMMARY
        echo "- SBOM (SPDX, CycloneDX)" >> $GITHUB_STEP_SUMMARY
        echo "- Vulnerability Reports" >> $GITHUB_STEP_SUMMARY
        echo "- Container Scan Results" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "Review artifacts in Actions tab." >> $GITHUB_STEP_SUMMARY

# =============================================================================
# Security Scan Configuration Notes:
# =============================================================================
# 1. Configure branch protection rules to require these checks
# 2. Set up GitHub Advanced Security for CodeQL
# 3. Add FOSSA_API_KEY secret for license scanning
# 4. Review and triage security findings regularly
# 5. Update dependencies to patch vulnerabilities
# 6. Monitor security advisories for libsodium and other deps
# =============================================================================
