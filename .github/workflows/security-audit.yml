name: Security Audit

on:
  push:
    branches: [ "main", "develop" ]
  pull_request:
    branches: [ "main" ]
  workflow_dispatch:  # Manual trigger
  schedule:
    - cron: '0 0 * * 0'  # Weekly on Sunday

jobs:
  # ============================================================================
  # Memory Safety Analysis
  # ============================================================================
  memory-sanitizers:
    name: Memory Safety (ASan + UBSan)
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          libsodium-dev \
          pkg-config \
          cmake \
          build-essential \
          gcc-13 \
          g++-13 \
          ninja-build

    - name: Configure with sanitizers
      run: |
        mkdir -p build-asan
        cd build-asan

        export CC=gcc-13
        export CXX=g++-13

        cmake .. \
          -DCMAKE_BUILD_TYPE=Debug \
          -DBUILD_TESTS=ON \
          -DENABLE_PQC=ON \
          -DCMAKE_C_FLAGS="-fsanitize=address,undefined -fno-omit-frame-pointer -g" \
          -DCMAKE_CXX_FLAGS="-fsanitize=address,undefined -fno-omit-frame-pointer -g" \
          -DCMAKE_EXE_LINKER_FLAGS="-fsanitize=address,undefined" \
          -G Ninja

    - name: Build with sanitizers
      run: |
        cd build-asan
        ninja -j2

    - name: Run tests with ASan/UBSan
      run: |
        cd build-asan
        export ASAN_OPTIONS=detect_leaks=1:symbolize=1:abort_on_error=1
        export UBSAN_OPTIONS=print_stacktrace=1:halt_on_error=1

        echo "Running nocturne-tests..."
        ./nocturne-tests || echo "nocturne-tests exit: $?"

        echo "Running side-channel-test..."
        ./side-channel-test || echo "side-channel-test exit: $?"

        echo "Running protocol-integration-test..."
        ./protocol-integration-test || echo "protocol-integration-test exit: $?"

        if [ -f ./pqc-comprehensive-test ]; then
          echo "Running pqc-comprehensive-test..."
          ./pqc-comprehensive-test || echo "pqc-comprehensive-test exit: $?"
        fi

    - name: Upload sanitizer logs
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: sanitizer-logs
        path: build-asan/*.log
        retention-days: 30

  # ============================================================================
  # Static Analysis
  # ============================================================================
  static-analysis:
    name: Static Analysis (cppcheck + clang-tidy)
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install analysis tools
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          cppcheck \
          clang-tidy-15 \
          libsodium-dev \
          pkg-config \
          cmake \
          ninja-build

    - name: Run cppcheck
      run: |
        cppcheck \
          --enable=all \
          --suppress=missingIncludeSystem \
          --suppress=unusedFunction \
          --inline-suppr \
          --error-exitcode=0 \
          --xml \
          --output-file=cppcheck-report.xml \
          src/ nocturne-kx.cpp 2>&1 | tee cppcheck.log

        echo "=== CPPCHECK SUMMARY ==="
        grep -E "(error|warning)" cppcheck.log | wc -l || echo "0 issues"

    - name: Configure for clang-tidy
      run: |
        mkdir -p build-analysis
        cd build-analysis
        cmake .. \
          -DCMAKE_BUILD_TYPE=Debug \
          -DBUILD_TESTS=ON \
          -DENABLE_PQC=ON \
          -DCMAKE_EXPORT_COMPILE_COMMANDS=ON \
          -G Ninja

    - name: Run clang-tidy
      run: |
        cd build-analysis

        # Run clang-tidy on main sources
        clang-tidy-15 \
          ../nocturne-kx.cpp \
          ../src/core/side_channel.cpp \
          ../src/pkcs11_wrapper.cpp \
          -p . \
          --config='' \
          2>&1 | tee ../clang-tidy.log || true

        echo "=== CLANG-TIDY SUMMARY ==="
        grep -E "warning:|error:" ../clang-tidy.log | wc -l || echo "0 issues"

    - name: Upload analysis reports
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: static-analysis-reports
        path: |
          cppcheck.log
          cppcheck-report.xml
          clang-tidy.log
        retention-days: 30

  # ============================================================================
  # Cryptographic Implementation Review
  # ============================================================================
  crypto-review:
    name: Cryptographic Implementation Review
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Check for hardcoded secrets
      run: |
        echo "=== SCANNING FOR HARDCODED SECRETS ==="

        # Search for potential hardcoded keys/secrets
        if grep -r -n -E "(password|secret|key)\s*=\s*['\"][^'\"]{8,}" src/ nocturne-kx.cpp 2>/dev/null; then
          echo "⚠️  WARNING: Potential hardcoded secrets found"
        else
          echo "✅ No hardcoded secrets detected"
        fi

    - name: Check for weak crypto patterns
      run: |
        echo "=== SCANNING FOR WEAK CRYPTO PATTERNS ==="

        # Check for deprecated/weak algorithms (word boundaries to avoid false positives)
        if grep -r -n -E "\b(MD5|SHA1|DES|RC4|ECB)\b" src/ nocturne-kx.cpp; then
          echo "⚠️  WARNING: Weak crypto algorithms detected"
          exit 1
        else
          echo "✅ No weak crypto algorithms found"
        fi

    - name: Validate random number generation
      run: |
        echo "=== VALIDATING RNG USAGE ==="

        # Check for proper libsodium RNG usage
        if grep -r "randombytes_buf" src/ nocturne-kx.cpp; then
          echo "✅ Using libsodium RNG (secure)"
        fi

        # Check for dangerous rand() usage
        if grep -r -E "\brand\(" src/ nocturne-kx.cpp; then
          echo "⚠️  WARNING: Using insecure rand()"
          exit 1
        else
          echo "✅ No insecure rand() usage"
        fi

    - name: Check constant-time operations
      run: |
        echo "=== VALIDATING CONSTANT-TIME OPERATIONS ==="

        # Check for timing-safe comparisons
        if grep -r "sodium_memcmp\|constant_time_compare" src/ nocturne-kx.cpp; then
          echo "✅ Using constant-time comparisons"
        fi

        # Check for dangerous memcmp on secrets
        if grep -r "std::memcmp.*secret\|memcmp.*key" src/ nocturne-kx.cpp; then
          echo "⚠️  WARNING: Potential timing leak in memcmp"
        fi

    - name: Validate key zeroing
      run: |
        echo "=== VALIDATING SECURE KEY ZEROING ==="

        if grep -r "sodium_memzero\|secure_zero_memory" src/ nocturne-kx.cpp; then
          echo "✅ Using secure memory zeroing"
        else
          echo "⚠️  WARNING: May not be zeroing sensitive data"
        fi

  # ============================================================================
  # Fuzzing Campaign
  # ============================================================================
  fuzzing:
    name: Fuzz Testing
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          libsodium-dev \
          pkg-config \
          cmake \
          clang-15 \
          libc++-15-dev \
          libc++abi-15-dev \
          ninja-build

    - name: Build fuzzer
      run: |
        mkdir -p build-fuzz
        cd build-fuzz

        export CC=clang-15
        export CXX=clang++-15

        cmake .. \
          -DCMAKE_BUILD_TYPE=Debug \
          -DBUILD_FUZZER=ON \
          -DENABLE_PQC=ON \
          -DCMAKE_C_COMPILER=clang-15 \
          -DCMAKE_CXX_COMPILER=clang++-15 \
          -DCMAKE_C_FLAGS="-fsanitize=fuzzer" \
          -DCMAKE_CXX_FLAGS="-stdlib=libc++ -fsanitize=fuzzer" \
          -DCMAKE_EXE_LINKER_FLAGS="-stdlib=libc++ -lc++abi -fsanitize=fuzzer" \
          -G Ninja

        ninja -j2

    - name: Run fuzzer (short campaign)
      run: |
        cd build-fuzz

        # Create corpus directory
        mkdir -p fuzz-corpus

        # Run fuzzer for 5 minutes
        timeout 300 ./nocturne-fuzzer fuzz-corpus/ || exit_code=$?

        if [ ${exit_code:-0} -eq 124 ]; then
          echo "✅ Fuzzer ran for 5 minutes without crashes"
        elif [ ${exit_code:-0} -eq 0 ]; then
          echo "✅ Fuzzer completed successfully"
        else
          echo "❌ Fuzzer found crashes (exit code: $exit_code)"
          exit 1
        fi

    - name: Upload crash artifacts
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: fuzzer-crashes
        path: build-fuzz/crash-*
        retention-days: 30

  # ============================================================================
  # Dependency Security Scan
  # ============================================================================
  dependency-scan:
    name: Dependency Vulnerability Scan
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Scan libsodium version
      run: |
        echo "=== LIBSODIUM VERSION CHECK ==="
        apt-cache policy libsodium-dev

        # Check for known vulnerabilities (manual for now)
        echo "Current libsodium from Ubuntu repos should be patched"

    - name: Check liboqs version
      run: |
        echo "=== LIBOQS VERSION CHECK ==="
        echo "Using liboqs 0.12.0 from GitHub (latest stable)"
        echo "Source: https://github.com/open-quantum-safe/liboqs/releases/tag/0.12.0"

    - name: Scan for vulnerable patterns
      run: |
        echo "=== SCANNING FOR VULNERABLE CODE PATTERNS ==="

        # Check for buffer overflows
        if grep -r -n "strcpy\|strcat\|sprintf" src/ nocturne-kx.cpp; then
          echo "⚠️  WARNING: Unsafe string functions found"
        else
          echo "✅ No unsafe string functions"
        fi

        # Check for format string vulnerabilities
        if grep -r -n "printf.*%s.*user" src/ nocturne-kx.cpp; then
          echo "⚠️  WARNING: Potential format string vulnerability"
        else
          echo "✅ No format string vulnerabilities detected"
        fi

  # ============================================================================
  # Audit Summary
  # ============================================================================
  audit-summary:
    name: Generate Audit Report
    runs-on: ubuntu-latest
    needs: [memory-sanitizers, static-analysis, crypto-review, fuzzing, dependency-scan]
    if: always()

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Generate summary report
      run: |
        cat > AUDIT_REPORT.md <<'EOF'
        # Security Audit Report
        **Project**: Nocturne-KX v4.0.0
        **Date**: $(date -u +"%Y-%m-%d %H:%M UTC")
        **Auditor**: Automated Security Pipeline

        ## Audit Scope

        - Memory safety (AddressSanitizer, UndefinedBehaviorSanitizer)
        - Static analysis (cppcheck, clang-tidy)
        - Cryptographic implementation review
        - Fuzz testing
        - Dependency vulnerability scanning

        ## Results Summary

        | Check | Status |
        |-------|--------|
        | Memory Sanitizers | ${{ needs.memory-sanitizers.result }} |
        | Static Analysis | ${{ needs.static-analysis.result }} |
        | Crypto Review | ${{ needs.crypto-review.result }} |
        | Fuzzing | ${{ needs.fuzzing.result }} |
        | Dependency Scan | ${{ needs.dependency-scan.result }} |

        ## Overall Assessment

        ${{ (needs.memory-sanitizers.result == 'success' && needs.static-analysis.result == 'success' && needs.crypto-review.result == 'success' && needs.fuzzing.result == 'success' && needs.dependency-scan.result == 'success') && '✅ **PASS** - All security checks passed' || '⚠️  **REVIEW REQUIRED** - Some checks failed or need attention' }}

        ## Recommendations

        - Review all artifacts from failed checks
        - Address high/critical severity findings
        - Re-run audit after fixes

        ---
        Generated by Nocturne-KX Security Audit Pipeline
        EOF

        cat AUDIT_REPORT.md

    - name: Upload audit report
      uses: actions/upload-artifact@v4
      with:
        name: security-audit-report
        path: AUDIT_REPORT.md
        retention-days: 90
